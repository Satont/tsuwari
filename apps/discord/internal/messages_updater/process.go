package messages_updater

import (
	"context"
	"errors"
	"log/slog"

	"github.com/samber/lo"
	"github.com/satont/twir/apps/discord/internal/sended_messages_store"
	model "github.com/satont/twir/libs/gomodels"
	"gorm.io/gorm"
)

func (c *MessagesUpdater) process(ctx context.Context) {
	messages, err := c.store.GetAll(ctx)
	if err != nil {
		c.logger.Error("Failed to get messages", slog.Any("err", err))
		return
	}

	streams := c.getStreams(ctx)
	// streams = lo.Filter(
	// 	streams,
	// 	func(stream model.ChannelsStreams, _ int) bool {
	// 		return stream.Channel != nil && stream.Channel.IsEnabled
	// 	},
	// )

	for _, stream := range streams {
		_, ok := lo.Find(
			messages,
			func(message sended_messages_store.Message) bool {
				return message.TwitchChannelID == stream.UserId
			},
		)
		if ok {
			continue
		}

		onlineMessages, err := c.sendOnlineMessage(ctx, stream)
		if err != nil {
			if !errors.Is(err, gorm.ErrRecordNotFound) && !errors.Is(err, ErrIntegrationNotFound) {
				c.logger.Error("Failed to send message", slog.Any("err", err))
			}
			continue
		}

		if len(onlineMessages) == 0 {
			continue
		}

		for _, m := range onlineMessages {
			err = c.store.Add(ctx, m)
			if err != nil {
				c.logger.Error("Failed to add message to store", slog.Any("err", err))
				continue
			}
		}
	}

	for _, message := range messages {
		stream, ok := lo.Find(
			streams,
			func(stream model.ChannelsStreams) bool { return stream.UserId == message.TwitchChannelID },
		)
		if !ok {
			if err = c.processOffline(ctx, message.TwitchChannelID); err != nil {
				if !errors.Is(err, ErrIntegrationNotFound) {
					c.logger.Error("Failed to process offline", slog.Any("err", err))
				}
				continue
			}

			if err = c.store.DeleteByMessageId(ctx, message.MessageID); err != nil {
				c.logger.Error("Failed to delete message from store", slog.Any("err", err))
			}

			continue
		}

		if err = c.updateDiscordMessages(ctx, stream); err != nil {
			if !errors.Is(err, ErrIntegrationNotFound) {
				c.logger.Error("Failed to process offline", slog.Any("err", err))
			}
			c.logger.Error("Failed to update message", slog.Any("err", err))
			continue
		}
	}
}

func (c *MessagesUpdater) getStreams(
	ctx context.Context,
) []model.ChannelsStreams {
	var streams []model.ChannelsStreams
	if err := c.db.WithContext(ctx).Find(&streams).Error; err != nil {
		c.logger.Error("Failed to get streams", slog.Any("err", err))
		return nil
	}

	return streams
}
