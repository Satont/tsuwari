docker: &docker
  image: plugins/docker
  depends_on:
    - build

docker-settings: &docker-settings
  registry: 
    from_secret: docker_hub
  username:
    from_secret: docker_username
  password:
    from_secret: docker_password
  tags: latest

kind: pipeline
type: docker
name: default

platform:
  os: linux
  arch: arm64

trigger:
  branch:
    - droneio
    - main

steps:
  - name: restore-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      restore: true
      mount:
        - ./node_modules

  - name: build
    image: node:18-slim
    commands: 
      - apt-get update
      - apt-get install curl wget git -y
      - npm i -g pnpm@7.5.0
      - pnpm install
      - pnpm build:backend
    depends_on:
      - restore-cache

  - name: rebuild-cache
    image: drillster/drone-volume-cache
    volumes:
      - name: cache
        path: /cache
    settings:
      rebuild: true
      mount:
        - ./node_modules
    depends_on:
      - build

  - name: publish-api
    <<: *docker
    settings:
      <<: *docker-settings
      repo: registry.tsuwari.tk/satont/drone-test-api
      dockerfile: ./apps/api/Dockerfile
    when:
      paths:
        include:
          - apps/api
          - package.json
          - pnpm-lock.yaml
          - libs/**/*

# - name: publish-bots
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-bots
#     dockerfile: ./apps/bots/Dockerfile

# - name: publish-dota
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-dota
#     dockerfile: ./apps/dota/Dockerfile

# - name: publish-eventsub
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-eventsub
#     dockerfile: ./apps/eventsub/Dockerfile

# - name: publish-migrations
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-migrations
#     dockerfile: ./libs/prisma/Dockerfile

# - name: publish-parser
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-parser
#     dockerfile: ./apps/parser/Dockerfile

# - name: publish-scheduler
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-scheduler
#     dockerfile: ./apps/scheduler/Dockerfile

# - name: publish-streamstatus
#   <<: *docker
#   settings:
#     <<: *docker-settings
#     repo: registry.tsuwari.tk/satont/drone-test-streamstatus
#     dockerfile: ./apps/streamstatus/Dockerfile

volumes:
  - name: cache
    host:
      path: /tmp/tsuwari-cache