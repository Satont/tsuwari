<script lang="ts" setup>
import { IconChevronRight } from '@tabler/icons-vue';
import { onClickOutside, onKeyStroke } from '@vueuse/core';
import { NAvatar, NInput, NSpin, NScrollbar, useThemeVars, NDivider, NText, NPopover } from 'naive-ui';
import { computed,  ref, watch } from 'vue';

import { useDashboards, useProfile, useSetDashboard, useTwitchGetUsers } from '@/api/index.js';

const emits = defineEmits<{
	dashboardSelected: []
}>();

const themeVars = useThemeVars();
const blockColor = computed(() => themeVars.value.buttonColor2);
const blockColor2 = computed(() => themeVars.value.buttonColor2Hover);

const { data: profile, isLoading: isProfileLoading } = useProfile();
const { data: dashboards, isLoading: isDashboardsLoading } = useDashboards();
const setDashboard = useSetDashboard();

const twitchUsersIds = computed<string[]>(() => {
	return [
		profile.value?.id,
		...(dashboards.value?.dashboards.map(d => d.id) ?? []),
	].filter(Boolean) as string[] ?? [];
});

const usersForSelect = useTwitchGetUsers({
	ids: twitchUsersIds,
});

const currentDashboard = computed(() => {
	const dashboard = usersForSelect.data.value?.users.find(u => u.id === profile.value?.selectedDashboardId);
	if (!dashboard) return null;

	return dashboard;
});

const activeDashboard = ref('');
watch(currentDashboard, (v) => {
	if (!v) return;
	activeDashboard.value = v.id;
}, { immediate: true });

watch(activeDashboard, async (v) => {
	if (v === profile.value?.selectedDashboardId) return;

	await setDashboard.mutateAsync(v);
	emits('dashboardSelected');
});

const filterValue = ref('');

const menuOptions = computed(() => {
	return usersForSelect.data.value?.users
		.filter(u => {
			return u.displayName.includes(filterValue.value) || u.login.includes(filterValue.value);
		})
		.map((u) => {
			return {
				key: u.id,
				label: u.login === u.displayName.toLocaleLowerCase()
					? u.displayName
					: `${u.displayName} (${u.login})`,
				icon: u.profileImageUrl,
			};
		}) ?? [];
});

const isSelectDashboardPopoverOpened = ref(false);
function togglePopover(value?: boolean) {
	isSelectDashboardPopoverOpened.value = value ?? !isSelectDashboardPopoverOpened.value;
}

function onSelectDashboard(key: string) {
	activeDashboard.value = key;
	togglePopover(false);
}

onKeyStroke('k', (event) => {
	if (event.ctrlKey || event.metaKey) {
		event.preventDefault();
		togglePopover();
	}
});

const refPopoverList = ref<HTMLElement | null>();
const refPopover = ref<HTMLElement | null>();
onClickOutside(refPopover, (event) => {
	if (isSelectDashboardPopoverOpened.value) {
		event.stopPropagation();
		togglePopover(false);
	}
}, { ignore: [refPopoverList] });
</script>

<template>
	<n-popover
		ref="refPopover"
		placement="bottom-start"
		trigger="manual"
		:show="isSelectDashboardPopoverOpened"
		:show-arrow="false"
	>
		<template #trigger>
			<div
				class="block"
				style="cursor: pointer;"
				@click="isSelectDashboardPopoverOpened = true"
			>
				<n-avatar
					style="display: flex; align-self: center; border-radius: 111px;"
					:src="currentDashboard?.profileImageUrl"
				/>
				<n-text>{{ currentDashboard?.displayName }}</n-text>

				<IconChevronRight
					:style="{
						transition: '0.2s transform ease',
						transform: `rotate(${!isSelectDashboardPopoverOpened ? 90 : -90}deg)`
					}"
				/>
			</div>
		</template>
		<n-spin v-if="isProfileLoading || isDashboardsLoading"></n-spin>
		<div v-else ref="refPopoverList">
			<div style="display: flex; gap: 12px; padding: 6px;">
				<n-avatar :src="currentDashboard?.profileImageUrl" round />
				<div style="display: flex; flex-direction: column;">
					<n-text depth="3" style="font-size: 12px;">
						Managing user
					</n-text>
					<n-text>{{ currentDashboard?.login }}</n-text>
				</div>
			</div>

			<n-divider style="margin-top: 3px; margin-bottom: 10px;" />

			<n-scrollbar style="max-height: 400px;" trigger="none">
				<div class="dashboards-menu">
					<div
						v-for="option of menuOptions"
						:key="option.key"
						secondary
						class="item"
						@click="onSelectDashboard(option.key)"
					>
						<n-avatar :src="option.icon" round size="small" />
						{{ option.label }}
					</div>
				</div>
			</n-scrollbar>
			<n-input v-if="(usersForSelect.data.value?.users?.length ?? 0) > 10" v-model:value="filterValue" placeholder="Search" />
		</div>
	</n-popover>
</template>

<style scoped>
.dashboards-menu {
	display: flex;
	flex-direction: column;
	gap: 4px;
	margin-right: 25px;
	margin-bottom: 10px;
}

.dashboards-menu .item {
	display: flex;
	gap: 12px;
	align-items: center;
	width: 100%;
	background-color: v-bind(blockColor);
	padding: 6px;
	border-radius: 6px;
	cursor: pointer;
}

.dashboards-menu .item:hover {
	background-color: v-bind(blockColor2);
}

.block {
	background-color: v-bind(blockColor);
	display: flex;
	gap: 16px;
	padding: 16px;
	border-radius: 10px;
	align-items: center;
}
</style>
